name: CI - All Services

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð° ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº Ð¿Ñ€Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°Ñ…
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== Detect Changes =====
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      bot: ${{ steps.filter.outputs.bot }}
      api: ${{ steps.filter.outputs.api }}
      frontend: ${{ steps.filter.outputs.frontend }}
      nginx: ${{ steps.filter.outputs.nginx }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            bot:
              - 'backend/bot/**'
              - '.build/Dockerfile'
              - '.github/workflows/ci.yml'
              - '.github/workflows/ci-bot.yml'
            api:
              - 'backend/api/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/ci-api.yml'
            frontend:
              - 'frontend/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/ci-frontend.yml'
            nginx:
              - '.build/nginx/**'
              - '.github/workflows/ci.yml'
              - '.github/workflows/ci-nginx.yml'

  # ===== Call Bot Workflow =====
  bot:
    name: Bot CI
    needs: changes
    # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ CI
    # if: needs.changes.outputs.bot == 'true'
    uses: ./.github/workflows/ci-bot.yml
    secrets: inherit

  # ===== Call API Workflow =====
  api:
    name: API CI
    needs: changes
    # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ CI
    # if: needs.changes.outputs.api == 'true'
    uses: ./.github/workflows/ci-api.yml
    secrets: inherit

  # ===== Call Frontend Workflow =====
  frontend:
    name: Frontend CI
    needs: changes
    # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ CI
    # if: needs.changes.outputs.frontend == 'true'
    uses: ./.github/workflows/ci-frontend.yml
    secrets: inherit

  # ===== Call Nginx Workflow =====
  nginx:
    name: Nginx CI
    needs: changes
    # Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ CI
    # if: needs.changes.outputs.nginx == 'true'
    uses: ./.github/workflows/ci-nginx.yml
    secrets: inherit

  # ===== Summary =====
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [changes, bot, api, frontend, nginx]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸŽ¯ CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **âš ï¸ Testing Mode**: All services are checked (change detection temporarily disabled)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Status:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Bot
          BOT_STATUS="${{ needs.bot.result }}"
          if [ "$BOT_STATUS" == "success" ]; then
            echo "- ðŸ¤– **Bot**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$BOT_STATUS" == "skipped" ]; then
            echo "- ðŸ¤– **Bot**: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ¤– **Bot**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # API
          API_STATUS="${{ needs.api.result }}"
          if [ "$API_STATUS" == "success" ]; then
            echo "- ðŸ”Œ **API**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$API_STATUS" == "skipped" ]; then
            echo "- ðŸ”Œ **API**: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ”Œ **API**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Frontend
          FRONTEND_STATUS="${{ needs.frontend.result }}"
          if [ "$FRONTEND_STATUS" == "success" ]; then
            echo "- ðŸŽ¨ **Frontend**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$FRONTEND_STATUS" == "skipped" ]; then
            echo "- ðŸŽ¨ **Frontend**: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸŽ¨ **Frontend**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Nginx
          NGINX_STATUS="${{ needs.nginx.result }}"
          if [ "$NGINX_STATUS" == "success" ]; then
            echo "- ðŸŒ **Nginx**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$NGINX_STATUS" == "skipped" ]; then
            echo "- ðŸŒ **Nginx**: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸŒ **Nginx**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
