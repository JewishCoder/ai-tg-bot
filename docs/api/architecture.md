# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Stats API

**–í–µ—Ä—Å–∏—è**: 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-10-17  
**–°—Ç–∞—Ç—É—Å**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (Mock API)

---

## üìã –û–±–∑–æ—Ä

Stats API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤ Telegram-–±–æ—Ç–∞. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö SOLID, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω Strategy –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö (Mock/Real).

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã**:
- **KISS** - –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π API –∫–æ–Ω—Ç—Ä–∞–∫—Ç (–µ–¥–∏–Ω—ã–π endpoint)
- **Strategy Pattern** - –ª–µ–≥–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É Mock –∏ Real —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏
- **Dependency Injection** - —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
- **Type Safety** - –ø–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Pydantic
- **OpenAPI First** - –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## üèóÔ∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. FastAPI Application (`src/app.py`)

–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ middleware –∏ —Ä–æ—É—Ç–µ—Ä–∞–º–∏.

**Responsibilities**:
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS middleware
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
- Health check endpoint
- Startup/Shutdown events

**Key Features**:
- OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ `/docs` –∏ `/redoc`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Graceful shutdown

```python
app = FastAPI(
    title="AI TG Bot Stats API",
    version="1.0.0",
    description="API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤"
)
```

---

### 2. Configuration (`src/config.py`)

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ Pydantic Settings.

**Responsibilities**:
- –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ `.env` —Ñ–∞–π–ª–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- Type-safe –¥–æ—Å—Ç—É–ø –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º

**Configuration Parameters**:
```python
class Config(BaseSettings):
    API_HOST: str = "0.0.0.0"
    API_PORT: int = 8000
    API_VERSION: str = "v1"
    STAT_COLLECTOR_TYPE: str = "mock"  # mock –∏–ª–∏ real
    CORS_ORIGINS: list[str] = [...]
    LOG_LEVEL: str = "INFO"
```

---

### 3. Stats Router (`src/routers/stats.py`)

REST endpoints –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

**Responsibilities**:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –í—ã–∑–æ–≤ StatCollector

**Endpoints**:
- `GET /api/v1/stats?period={day|week|month}` - –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**Dependency Injection**:
```python
async def get_stat_collector() -> StatCollector:
    if config.STAT_COLLECTOR_TYPE == "mock":
        return MockStatCollector()
    else:
        return RealStatCollector()  # –±—É–¥—É—â–µ–µ

@router.get("/stats")
async def get_stats(
    period: Literal["day", "week", "month"],
    collector: Annotated[StatCollector, Depends(get_stat_collector)]
):
    return await collector.get_stats(period)
```

---

### 4. StatCollector (Strategy Pattern)

#### 4.1 Abstract Base Class (`src/stats/collector.py`)

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö —Å–±–æ—Ä—â–∏–∫–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

```python
class StatCollector(ABC):
    @abstractmethod
    async def get_stats(self, period: PeriodType) -> StatsResponse:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥."""
        pass
```

**Benefits**:
- –ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è Mock –∏ Real —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π
- –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ –º–æ–∫–∏

#### 4.2 Mock Implementation (`src/stats/mock_collector.py`)

Mock —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ frontend –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î.

**Responsibilities**:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π seed)
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ (–ø–∏–∫–∏ –¥–Ω—ë–º, —Å–ø–∞–¥—ã –Ω–æ—á—å—é)

**Algorithm**:
```python
class MockStatCollector(StatCollector):
    def __init__(self, seed: int = 42):
        self._random = random.Random(seed)
    
    async def get_stats(self, period: PeriodType) -> StatsResponse:
        summary = self._generate_summary(period)
        activity_timeline = self._generate_activity_timeline(period)
        recent_dialogs = self._generate_recent_dialogs()
        top_users = self._generate_top_users()
        
        return StatsResponse(
            summary=summary,
            activity_timeline=activity_timeline,
            recent_dialogs=recent_dialogs,
            top_users=top_users
        )
```

**Data Generation**:
- **Summary**: –∑–Ω–∞—á–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –ø–æ –ø–µ—Ä–∏–æ–¥—É (day √ó 1.0, week √ó 3.5, month √ó 15.0)
- **Activity Timeline**: 24/7/30 —Ç–æ—á–µ–∫ —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏
- **Recent Dialogs**: 10-15 –¥–∏–∞–ª–æ–≥–æ–≤ —Å —É–±—ã–≤–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
- **Top Users**: 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

#### 4.3 Real Implementation (Future)

Real —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ PostgreSQL.

**Future Responsibilities**:
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ AsyncSession
- SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–∏–Ω–¥–µ–∫—Å—ã, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î

---

### 5. Pydantic Models (`src/stats/models.py`)

Type-safe –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π.

**Models**:

```python
class Summary(BaseModel):
    """–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥."""
    total_users: int = Field(ge=0)
    total_messages: int = Field(ge=0)
    active_dialogs: int = Field(ge=0)

class ActivityPoint(BaseModel):
    """–¢–æ—á–∫–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."""
    timestamp: datetime
    message_count: int = Field(ge=0)
    active_users: int = Field(ge=0)

class RecentDialog(BaseModel):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ–¥–∞–≤–Ω–µ–º –¥–∏–∞–ª–æ–≥–µ."""
    user_id: int = Field(gt=0)
    message_count: int = Field(ge=1)
    last_message_at: datetime
    duration_minutes: int = Field(ge=0)

class TopUser(BaseModel):
    """–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."""
    user_id: int = Field(gt=0)
    total_messages: int = Field(ge=1)
    dialog_count: int = Field(ge=1)
    last_activity: datetime

class StatsResponse(BaseModel):
    """–ö–æ—Ä–Ω–µ–≤–∞—è –º–æ–¥–µ–ª—å –æ—Ç–≤–µ—Ç–∞ API."""
    summary: Summary
    activity_timeline: list[ActivityPoint]
    recent_dialogs: list[RecentDialog]
    top_users: list[TopUser]
```

**Benefits**:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- JSON serialization/deserialization
- OpenAPI schema generation
- Type hints –¥–ª—è IDE

---

## üîÑ Request Flow

### –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞ –∑–∞–ø—Ä–æ—Å–∞

```mermaid
sequenceDiagram
    participant Client
    participant FastAPI
    participant Router
    participant Dependency
    participant StatCollector
    participant Pydantic

    Client->>FastAPI: GET /api/v1/stats?period=day
    FastAPI->>Router: Route to stats router
    Router->>Dependency: get_stat_collector()
    Dependency->>StatCollector: Create MockStatCollector()
    Router->>Pydantic: Validate period parameter
    Router->>StatCollector: collector.get_stats("day")
    StatCollector->>StatCollector: Generate mock data
    StatCollector->>Pydantic: Validate StatsResponse
    Pydantic-->>Router: Valid StatsResponse
    Router-->>FastAPI: Response data
    FastAPI-->>Client: JSON Response (200 OK)
```

### –ü–æ—à–∞–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

1. **Client Request**: HTTP GET –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `period`
2. **FastAPI Routing**: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ stats router
3. **Dependency Injection**: –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ StatCollector (Mock –∏–ª–∏ Real)
4. **Parameter Validation**: Pydantic –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç `period` (Literal["day", "week", "month"])
5. **Data Collection**: StatCollector –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç/–ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
6. **Response Validation**: Pydantic –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞
7. **JSON Serialization**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ JSON
8. **HTTP Response**: –í–æ–∑–≤—Ä–∞—Ç 200 OK —Å –¥–∞–Ω–Ω—ã–º–∏

---

## üéØ Design Patterns

### 1. Strategy Pattern

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**: StatCollector —Å Mock/Real —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏

**Benefits**:
- –õ–µ–≥–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏)

**Example**:
```python
def get_stat_collector() -> StatCollector:
    if config.STAT_COLLECTOR_TYPE == "mock":
        return MockStatCollector()
    elif config.STAT_COLLECTOR_TYPE == "real":
        return RealStatCollector(database)
    elif config.STAT_COLLECTOR_TYPE == "cache":
        return CachedStatCollector(database, redis)
```

---

### 2. Dependency Injection

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**: FastAPI Dependencies –¥–ª—è StatCollector

**Benefits**:
- –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å (–ª–µ–≥–∫–æ –ø–æ–¥–º–µ–Ω–∏—Ç—å –Ω–∞ –º–æ–∫–∏ –≤ —Ç–µ—Å—Ç–∞—Ö)
- –ò–Ω–≤–µ—Ä—Å–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—Ä–æ—É—Ç–µ—Ä –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ—Å—Ç—å

**Example**:
```python
async def get_stats(
    collector: Annotated[StatCollector, Depends(get_stat_collector)]
):
    # collector –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    return await collector.get_stats(period)
```

---

### 3. Repository Pattern (Future - Real Implementation)

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**: –ò–∑–æ–ª—è—Ü–∏—è –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î

**Structure**:
```python
class StatsRepository:
    def __init__(self, session: AsyncSession):
        self.session = session
    
    async def get_summary(self, period: Period) -> Summary:
        # SQL –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
        pass

class RealStatCollector(StatCollector):
    def __init__(self, repository: StatsRepository):
        self.repository = repository
    
    async def get_stats(self, period: PeriodType) -> StatsResponse:
        summary = await self.repository.get_summary(period)
        # ...
```

---

## üìä Data Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ HTTP GET /api/v1/stats?period=day
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         FastAPI App                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  CORS Middleware            ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ               ‚ñº                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  Stats Router              ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - Validate params         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  - Inject dependencies     ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Dependency Injector  ‚îÇ
    ‚îÇ  get_stat_collector() ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   StatCollector       ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ Strategy Pattern
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MockCollector‚îÇ  ‚îÇRealCollector‚îÇ (Future)
‚îÇ - Generate   ‚îÇ  ‚îÇ - Query DB  ‚îÇ
‚îÇ   mock data  ‚îÇ  ‚îÇ - Aggregate ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                 ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Pydantic Models     ‚îÇ
    ‚îÇ   - Validate          ‚îÇ
    ‚îÇ   - Serialize         ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ JSON Response‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    Client    ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîê Error Handling

### Error Types

1. **Validation Errors (422)**
   - –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `period`
   - FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

2. **Internal Errors (500)**
   - –û—à–∏–±–∫–∏ –≤ StatCollector
   - –û—à–∏–±–∫–∏ –ë–î (–≤ Real implementation)
   - –õ–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–ª–Ω—ã–º traceback

### Error Response Format

```json
{
  "detail": [
    {
      "type": "literal_error",
      "loc": ["query", "period"],
      "msg": "Input should be 'day', 'week' or 'month'",
      "input": "invalid"
    }
  ]
}
```

---

## üöÄ Deployment

### Docker

API —É–ø–∞–∫–æ–≤–∞–Ω –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è.

**Dockerfile**:
- Base: `python:3.11-slim`
- Package manager: `uv`
- Non-root user: `apiuser`
- Health check: `GET /health`

**docker-compose.yml**:
```yaml
api:
  build: ./backend/api
  ports:
    - "8080:8000"
  environment:
    - STAT_COLLECTOR_TYPE=mock
  healthcheck:
    test: ["CMD", "curl", "http://localhost:8000/health"]
```

---

## üìà Performance Considerations

### Current (Mock API)
- Response time: < 50ms
- No external dependencies
- CPU-bound (data generation)

### Future (Real API with DB)
- Response time target: < 500ms
- Database indexing strategy
- Connection pooling
- Query optimization
- Caching layer (Redis)

**Optimization Plan**:
1. –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `created_at`, `deleted_at`, `user_id`
2. –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
3. Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (TTL 5 –º–∏–Ω—É—Ç)
4. Background tasks –¥–ª—è –ø—Ä–µ–¥—Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## üß™ Testing Strategy

### Unit Tests
- Mock StatCollector logic
- Pydantic model validation
- Configuration loading

### Integration Tests
- Full API request/response cycle
- Dependency injection
- Error handling

### Coverage Target
- **Current**: 100% for Mock implementation
- **Target for Real**: 80%+

---

## üîÆ Future Enhancements

### Phase 1: Real StatCollector
- [ ] PostgreSQL integration
- [ ] SQL query optimization
- [ ] Error handling for DB failures

### Phase 2: Performance
- [ ] Redis caching layer
- [ ] Background tasks for precomputation
- [ ] Materialized views

### Phase 3: Features
- [ ] Custom date ranges
- [ ] Export to CSV/PDF
- [ ] Webhooks for real-time updates
- [ ] GraphQL endpoint (optional)

---

## üìö Related Documents

- [API Contract](stats-api-contract.md) - REST API specification
- [Dashboard Requirements](../frontend/dashboard-requirements.md) - UI requirements
- [Mock Collector](mock-collector.md) - Mock implementation details
- [Roadmap](../roadmap.md) - Project roadmap

---

**Last Updated**: 2025-10-17  
**Version**: 1.0.0

